name: Developer Sandbox Org

on:
    push:
      branches:
        - developer
      paths:
       - 'force-app/**'
    workflow_dispatch:

jobs:
    Build:
      name: environment-setup
      runs-on: ubuntu-latest
      steps:
          # Checkout the Source code from the latest commit
          - uses: actions/checkout@v3
            with:
              fetch-depth: 0
          - name: Install the SFDX CLI
            run: |
              npm install @salesforce/cli --global
              sf --help
          - name: Decrypt the server.key.enc file & store inside assets folder
            run: |
              openssl enc -nosalt -aes-256-cbc -d -in ${{ secrets.ENCRYPTION_KEY_FILE }} -out ${{ secrets.JWT_KEY_FILE }} -base64 -K ${{ secrets.DECRYPTION_KEY }} -iv ${{ secrets.DECRYPTION_IV }}
              
          - name: Authenticate Salesforce ORG
            run: |
              sf org login jwt --client-id ${{ secrets.HUB_CONSUMER_KEY }} --jwt-key-file  ${{ secrets.JWT_KEY_FILE }} --username ${{ secrets.HUB_USER_NAME }} --set-default --alias HubOrg --instance-url ${{ secrets.HUB_LOGIN_URL }} 
          
          - name: Validate components to Salesforce
            run: |
              sf project deploy validate --manifest delta/package/package.xml --test-level RunLocalTests --target-org HubOrg --coverage-formatters clover
              
          - name: Deploy Delta components to Salesforce
            run: |
              sf project deploy start --manifest delta/package/package.xml --test-level RunLocalTests --target-org HubOrg --coverage-formatters clover
